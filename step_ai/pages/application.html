<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
        <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
        <script src="/blog/step_ai/pages/code.js"></script>
        <link rel="stylesheet" href="style.css">

    <style>

</style>
    </head>
    <body>
        <h1> Step Counter</h1>

        <label for="algup" class="upload">Upload Algorithm</label>
        <input type="file" id="algup" style="opacity: 1;"><br><br>

        <label for="kiup" class="upload">Upload KI</label>
        <input type="file" id="kiup" style="opacity: 1;"><br><br><br><br>

        <input type="button" class="button" value="Start" ></input><br>
        <div style="float:left;">
            Programm: <div id="steps_program">0</div>
        </div>
        <div style="float:right;">
            Ki: <div id="steps_ki">0</div>
        </div>
    <div id="charts" style="clear: both;">
        <div id ="gyr" class="container">
            <canvas id="gyr_x" width="300" height="200"></canvas>
            <canvas id="gyr_y" width="300" height="200"></canvas>
            <canvas id="gyr_z" width="300" height="200"></canvas>
        </div>
        <div id="accs" class="container">
            <canvas id="acc_x" width="300" height="200"></canvas>
            <canvas id="acc_y" width="300" height="200"></canvas>
            <canvas id="acc_z" width="300" height="200"></canvas>
        </div>
        <div id="orientation" class="container">
            <canvas id="o_a" width="300" height="200"></canvas>
            <canvas id="o_b" width="300" height="200"></canvas>
            <canvas id="o_d" width="300" height="200"></canvas>
        </div>
    </div>
        <script>

            STORAGE_ALGORITHM = "Ki_data_algorithm"
            STORAGE_MODEL = "ki_data_stored"
            // load pyiodide program
            pyodide = 0;
            draw_coordinate_systems();
            async function setup_pyodide(){
                
                pyodide =await loadPyodide();

                // load algorithm
                const algorithm = JSON.parse(window.localStorage.getItem(STORAGE_ALGORITHM));
                pyodide.runPython(algorithm)


                // load AI model 
                const ai_model = JSON.parse(window.localStorage.getItem(STORAGE_MODEL));
                pyodide.globals.set("W", JSON.parse(ai_model.W))
                pyodide.runPython(ai_model.code);

            }
            setup_pyodide();


            // ad
        document.getElementById('algup').addEventListener('change', function(event) {
                function handleFileLoad(event) {
                    let file_content = JSON.parse(event.srcElement.result);
                    window.localStorage.setItem(STORAGE_ALGORITHM, JSON.stringify(file_content));
                    const algorithm = JSON.parse(window.localStorage.getItem(STORAGE_ALGORITHM));
                    pyodide.runPython(algorithm)
                }
                const reader = new FileReader()
                reader.onload = handleFileLoad;
                reader.readAsText(event.target.files[0])
          });

        document.getElementById('kiup').addEventListener('change', function(event) {
                function handleFileLoad(event) {
                    let file_content = JSON.parse(event.srcElement.result);
                    window.localStorage.setItem(STORAGE_MODEL, JSON.stringify(file_content));
                    const ai_model = JSON.parse(window.localStorage.getItem(STORAGE_MODEL));
                    pyodide.globals.set("W", JSON.parse(ai_model.W))
                    pyodide.runPython(ai_model.code);
                }
                const reader = new FileReader()
                reader.onload = handleFileLoad;
                reader.readAsText(event.target.files[0])
          });
            // prepare data collection

            total_steps_program = 0

            function predict_steps(systems){
                const func = pyodide.globals.get("steps_made");
                const steps = func(systems[0]["values"], systems[1]["values"], systems[2]["values"],systems[3]["values"],systems[4]["values"],systems[5]["values"],systems[6]["values"],systems[7]["values"],systems[8]["values"])
                total_steps_program += steps
                document.getElementById("steps_program").textContent = total_steps_program; 
            }

            total_steps_ki = 0;

            function predict_ai(systems){
                const func = pyodide.globals.get("predict");

                let tmp = []
                feature_order.forEach((item =>{
                        w = item[0]
                        s = item[1]
                    const key_object = systems.find((e)=>e["name"]===w);
                    tmp.push(...key_object["values"].map(u=>u*s))
                }
                ))
                const steps = func([tmp])
                console.log(steps)
                total_steps_ki += Math.round(steps)
                document.getElementById("steps_ki").textContent = total_steps_ki 
            }


            function predict_both(systems){
                predict_steps(systems);
                predict_ai(systems);
            }

            function start_recording(){ 
                total_steps_ki = 0
                document.getElementById("steps_ki").textContent = Math.round(total_steps_ki); 

                total_steps_program = 0
                document.getElementById("steps_program").textContent = total_steps_program; 

                handleMotion = createHandle(true, predict_both);
                add_orientation_eventlistner(handleOrientation)
                add_motion_eventlistner(handleMotion)
            }

            document.getElementsByClassName("button")[0].addEventListener("click",start_recording)


        </script>
    </body>
</html>
